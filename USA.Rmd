---
title: "USA, Covid-19 situation by state"
author: "Mitsuo Shiota"
date: "2020/5/26"
output: 
  github_document:
    toc: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Updated: `r Sys.Date()`

## Summary

I added the United States page to [my Shiny App](https://mitsuoxv.shinyapps.io/covid/) on May 25, 2020. I use data of 50 states and 1 federal district (District of Columbia) from [USAFacts page](https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/).

```{r library, include=FALSE}
library(tidyverse)
library(rvest)
library(readxl)
library(maps)
library(tsibble)
library(tqr)
library(scales)
```

```{r read_from_USAfacts, echo=FALSE, cache=FALSE}
# https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/
# Read confirmed cases
conf_raw <- read_csv("https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_confirmed_usafacts.csv",
                     col_types = cols(
                       .default = col_double(),
                       `County Name` = col_character(),
                       State = col_character()
                       )
                     )

conf_raw <- conf_raw %>% 
  drop_na(countyFIPS)

conf_total <- conf_raw %>% 
  pivot_longer(!c(1:4), names_to = "publish_date", values_to = "cum_conf") %>% 
  mutate(publish_date = as.Date(publish_date, "%m/%d/%y")) %>% 
  group_by(publish_date) %>% 
  summarize(cum_conf = sum(cum_conf), .groups = "drop_last") %>% 
  mutate(
    cum_conf_lag = lag(cum_conf),
    new_conf = cum_conf - cum_conf_lag
  ) %>% 
  select(-cum_conf_lag) %>% 
  mutate(State = "Total")

conf_by_state <- conf_raw %>% 
  pivot_longer(!c(1:4), names_to = "publish_date", values_to = "cum_conf") %>% 
  mutate(publish_date = as.Date(publish_date, "%m/%d/%y")) %>% 
  group_by(State, publish_date) %>% 
  summarize(cum_conf = sum(cum_conf), .groups = "drop_last") %>% 
  mutate(
    cum_conf_lag = lag(cum_conf),
    new_conf = cum_conf - cum_conf_lag
  ) %>% 
  select(-cum_conf_lag)

conf <- bind_rows(conf_total, conf_by_state) %>% 
  filter(!is.na(publish_date))

# Read deaths
deaths_raw <- read_csv("https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_deaths_usafacts.csv",
                       col_types = cols(
                         .default = col_double(),
                         `County Name` = col_character(),
                         State = col_character()
                         )
                       )

deaths_total <- deaths_raw %>% 
  pivot_longer(!c(1:4), names_to = "publish_date", values_to = "cum_deaths") %>% 
  mutate(publish_date = as.Date(publish_date, "%m/%d/%y")) %>% 
  group_by(publish_date) %>% 
  summarize(cum_deaths = sum(cum_deaths), .groups = "drop_last") %>% 
  mutate(
    cum_deaths_lag = lag(cum_deaths),
    new_deaths = cum_deaths - cum_deaths_lag
  ) %>% 
  select(-cum_deaths_lag) %>% 
  mutate(State = "Total")

deaths_by_state <- deaths_raw %>% 
  pivot_longer(!c(1:4), names_to = "publish_date", values_to = "cum_deaths") %>% 
  mutate(publish_date = as.Date(publish_date, "%m/%d/%y")) %>% 
  group_by(State, publish_date) %>% 
  summarize(cum_deaths = sum(cum_deaths), .groups = "drop_last") %>% 
  mutate(
    cum_deaths_lag = lag(cum_deaths),
    new_deaths = cum_deaths - cum_deaths_lag
  ) %>% 
  select(-cum_deaths_lag)

deaths <- bind_rows(deaths_total, deaths_by_state) %>% 
  filter(!is.na(publish_date))

# Bind
data_usa <- left_join(conf, deaths, by = c("State", "publish_date"))

# Add state name column
states <- 
  bind_rows(
    tibble(
      State = state.abb,
      state_name = state.name
    ),
    tibble(
      State = c("DC", "Total"),
      state_name = c("District of Columbia", "Total")
    )
  )

data_usa <- data_usa %>% 
  left_join(states, by = "State")

saveRDS(data_usa, "data/data_usa.rds")
```


```{r preparation, echo=FALSE, message=FALSE}
# add party
gov_html <- read_html("https://en.wikipedia.org/wiki/List_of_United_States_governors")

gov_df <- gov_html %>% 
  html_nodes("table") %>% 
  .[[1]] %>% 
  html_table(fill = TRUE)

gov_df <- gov_df[-1, c(1, 5)]

names(gov_df) <- c("state_name", "party")

gov_df <- gov_df %>% 
  mutate(party = str_sub(party, 1L, 10L))

dc_df <- gov_html %>% 
  html_nodes("table") %>% 
  .[[3]] %>% 
  html_table(fill = TRUE)

dc_df <- dc_df[-1, c(1, 5)]

names(dc_df) <- c("state_name", "party")

gov_dc_df <- bind_rows(gov_df, dc_df)

data_usa <- data_usa %>% 
  filter(State != "Total") %>% 
  left_join(gov_dc_df, by = "state_name")

# add population
population <- read_excel("data/nst-est2019-01.xlsx", 
    col_names = FALSE, skip = 9)

population <- population[1:51, c(1, 13)]

names(population) <- c("state_name", "pop")

population <- population %>% 
  mutate(
    state_name = str_sub(state_name, 2L, -1L)
    )

data_usa <- data_usa %>% 
  left_join(population, by = "state_name")
```

I separate red or blue by state governors (in case of DC, a mayor), according to [List of United States governors](https://en.wikipedia.org/wiki/List_of_United_States_governors). Out of the map below, Alaska is red and Hawaii is blue. I download population data in data directory from [Census Bureau page](https://www.census.gov/data/tables/time-series/demo/popest/2010s-state-total.html), and use estimated population as of July 1, 2019.

```{r map, echo=FALSE}
states_map <- map_data("state")

states_party <- gov_dc_df %>% 
  left_join(population, by = "state_name") %>% 
  mutate(
    state = tolower(state_name),
    pop_mil = pop / 1000000
    ) %>% 
  select(-state_name, -pop)

states_map %>% 
  left_join(states_party, by = c("region" = "state")) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = party, alpha = pop_mil)) +
  geom_polygon(color = "white") +
  coord_map("polyconic") +
  scale_fill_manual(values = c("blue", "red")) +
  theme_void()
```

## U.S. confirmed cases (new) by red or blue states

I am worrying that too vigorous "reopen economy" movements in the red states in the United States may cause the second wave.

```{r chart1, echo=FALSE, warning=FALSE}
data_usa %>% 
  group_by(publish_date, party) %>% 
  summarize(new_conf = sum(new_conf), .groups = "drop_last") %>% 
  as_tsibble(key = party, index = publish_date) %>% 
  tq_ma(7) %>% 
  ggplot(aes(publish_date, new_conf, color = party)) +
  geom_line(size = 1) +
  scale_color_manual(values = c("blue", "red")) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Confirmed cases (new) by red or blue states",
    x = "published date (7 days average)",
    y = NULL,
    caption = str_c("Latest: ", max(data_usa$publish_date)),
    color = NULL
  ) +
  theme(
    plot.title = element_text(size = rel(2)))
```

Populations in millions by red or blue are:

```{r population_by_party, echo=FALSE}
data_usa %>% 
  filter(publish_date == max(publish_date)) %>% 
  group_by(party) %>% 
  summarize(pop_mil = sum(pop) / 1000000, .groups = "drop_last")
```


## Fastest spreading states in the last 14 days

Highest "increase_in_14_days",  which is an increase in cumulative confirmed cases in the last 14 days, are:

```{r per_capita, echo=FALSE}
states_speed <- data_usa %>% 
  group_by(state_name) %>% 
  filter(publish_date > max(publish_date) - 14) %>% 
  summarize(increase_in_14_days = sum(new_conf), .groups = "drop_last") %>% 
  mutate(state = tolower(state_name)) %>% 
  select(-state_name)

states_map %>% 
  left_join(states_speed, by = c("region" = "state")) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = increase_in_14_days)) +
  geom_polygon(color = "white") +
  coord_map("polyconic") +
  scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
                       midpoint = median(states_speed$increase_in_14_days)) +
  theme_void()
```

Above calculation might be unfair to populous states. Highest "increase_std_in_14_days", which is an increase in cumulative confirmed cases in the last 14 days per 1 million population, are:

```{r standardized, echo=FALSE}
states_speed_std <- data_usa %>% 
  group_by(state_name) %>% 
  filter(publish_date > max(publish_date) - 14) %>% 
  summarize(increase_std_in_14_days = sum(new_conf * 1000000 / pop), .groups = "drop_last") %>% 
  mutate(state = tolower(state_name)) %>% 
  select(-state_name)

states_map %>% 
  left_join(states_speed_std, by = c("region" = "state")) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = increase_std_in_14_days)) +
  geom_polygon(color = "white") +
  coord_map("polyconic") +
  scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
                       midpoint = median(states_speed_std$increase_std_in_14_days)) +
  theme_void()
```


## Highest fatality rate states

Among states with more than 10 cumulative deaths, highest "fatality_rate", which is cumulative deaths per 100 cumulative confirmed cases, are:

```{r fatality_rates, echo=FALSE}
states_fatality <- data_usa %>% 
  filter(
    cum_deaths > 10,
    publish_date == max(publish_date)
    ) %>% 
  mutate(fatality_rate = cum_deaths * 100 / cum_conf) %>% 
  select(state_name, fatality_rate) %>% 
  mutate(state = tolower(state_name)) %>% 
  select(-state_name)

states_map %>% 
  left_join(states_fatality, by = c("region" = "state")) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = fatality_rate)) +
  geom_polygon(color = "white") +
  coord_map("polyconic") +
  scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
                       midpoint = median(states_fatality$fatality_rate)) +
  theme_void()
```

## Highest deaths per population states

Highest "deaths_per_1m", which is cumulative deaths per 1 million population, are:

```{r deaths_per_population, echo=FALSE}
states_deaths <- data_usa %>% 
  filter(
    publish_date == max(publish_date)
    ) %>% 
  mutate(
    pop_mil = pop / 1000000,
    deaths_per_1m = cum_deaths / pop_mil
    ) %>% 
  select(state_name, deaths_per_1m) %>% 
  mutate(state = tolower(state_name)) %>% 
  select(-state_name)

states_map %>% 
  left_join(states_deaths, by = c("region" = "state")) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = deaths_per_1m)) +
  geom_polygon(color = "white") +
  coord_map("polyconic") +
  scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
                       midpoint = median(states_deaths$deaths_per_1m)) +
  theme_void()
```

EOL

