---
title: "Japan, weekly confirmed Covid-19 cases per hospital"
author: "Mitsuo Shiota"
date: "2023-05-20"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Updated: `r Sys.Date()`

## Covid-19 was reclassified as tier 5 on May 8, 2023 in Japan

There are no daily data available on Covid-19 since May 8, 2023 in Japan. Instead, MHLW (Ministry of Health, Labour and Welfare) publishes weekly data in [its web site](https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/0000121431_00432.html).

```{r library, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)

library(NipponMap)
library(sf)

library(pdftools)
```

## Read data from MHLW site

```{r end_row_num}
end_row_num <- 36
```

```{r pref_eng}
pref_eng <- read_csv("data-raw/pref_eng.csv") |> 
  mutate(code = sprintf("%02.0f", 0:47))
```

```{r read_data_from_MHLW, message=FALSE}
conf_num <- read_excel("data-raw/001098622.xlsx",
                       range = paste0("A5:AX", end_row_num)) |>
  set_names("start", "end", pref_eng$prefecture) |>
  pivot_longer(!start:end, names_to = "prefecture", values_to = "value") |>
  mutate(
    start = as.Date(start),
    concept = "new_conf_wk"
    ) |> 
  select(publish_date = start, prefecture, value)

conf_per_hospital <- read_excel("data-raw/001098622.xlsx",
                   range = paste0("A", end_row_num + 6, ":AX", end_row_num * 2 + 1)) |> 
  set_names("start", "end", pref_eng$prefecture) |>
  pivot_longer(!start:end, names_to = "prefecture", 
               values_to = "value_per_hospital") |> 
  select(value_per_hospital)

in_japan_wk <- bind_cols(conf_num, conf_per_hospital) |> 
  left_join(pref_eng, by = "prefecture")
```

```{r prepare_for_pdf}
# Split by line
make_lines <- function(a_list) {
  a_list |> 
    str_split("\n") |> 
    unlist()
}

# read character vector into a tibble, split by >= 5 spaces
read_chr_vec <- function(chr_vec, skip, expect_col_num) {
  
  chr_vec[(skip + 1):length(chr_vec)] |> 
    str_split("\\s{5,}") |> 
    unlist() |> 
    matrix(ncol = expect_col_num, byrow = TRUE) |> 
    as_tibble(.name_repair = "minimal")
}
```

```{r read_from_pdf}
# Extract text
texts <- pdf_text("data-raw/001098617.pdf")

str(texts)

# Split into lines
lines <- texts  %>% 
  make_lines()

# Table
table_start <- str_which(lines, "新型コロナウイルス感染症（COVID-19）定点当たり報告数・都道府県別")

table_end <- str_which(lines, "新型コロナウイルス感染症（COVID-19）定点当たり報告数推移")

lines_table <- lines[table_start:(table_end - 2)]
  
df_table <- read_chr_vec(lines_table, skip = 5, expect_col_num = 3) |> 
  set_names("prefecture_kj", "value", "value_per_hospital") |> 
  mutate(across(value:value_per_hospital, parse_number))

date_line <- lines_table[2]

py <- str_extract(date_line, "(\\d+)年", group = 1) |> as.numeric()
pm <- str_extract(date_line, "(\\d+)月", group = 1) |> as.numeric()
pd <- str_extract(date_line, "(\\d+)日", group = 1) |> as.numeric()

# add publish_date
df_table <- bind_cols(df_table[c(48, 1:47), ], pref_eng) |> 
  mutate(publish_date = make_date(py, pm, pd)) |> 
  select(-prefecture_kj)

# add pdf data
in_japan_wk <- bind_rows(in_japan_wk, df_table)
```

## Weekly confirmed cases per hospital

```{r conf_per_hospital}
in_japan_wk |> 
  filter(prefecture != "Total") |> 
  ggplot(aes(publish_date, value_per_hospital)) +
  geom_line(aes(color = prefecture), show.legend = FALSE) +
  geom_line(data = in_japan_wk |> filter(prefecture == "Total"),
            color = "black", linewidth = 1) +
  labs(x = NULL, y = "Cases per hospital",
       title = paste0("Weekly confirmed cases; latest week is up to ", max(conf_per_hospital$publish_date)),
       subtitle = "47 prefectures are colored lines, and the national average is a black line",
       caption = "Source: Ministry of Health, Labour and Welfare")
```

## Confirmed Covid-19 cases per hospital in the latest week by prefecuture

```{r map_draw_prepare, include=FALSE}

# read map data
prefectures_map <-
  st_read(system.file("shapes/jpn.shp", package = "NipponMap"))

draw_map_japan <- function(map_df, df, var) {
  map_df %>%
    left_join(df, by = c(jiscode = "code")) %>%
    ggplot() +
    geom_sf(aes(fill = {{ var }}), color = "white") +
    scale_fill_gradient2(low = "#559999", mid = "grey90", high = "#BB650B",
                         midpoint = median(df %>% pull({{ var }}))) +
    theme_void()
}
```

```{r conf_per_hospital_last, echo=FALSE}
in_japan_wk_last <- in_japan_wk |> 
  filter(prefecture != "Total") |> 
  group_by(code) |> 
  filter(publish_date == max(publish_date)) |> 
  ungroup()

draw_map_japan(prefectures_map,
               in_japan_wk_last,
               value_per_hospital) +
  labs(fill = "Cases")
```

For more flexible data presentations, please check [my Shiny app](https://mitsuoxv.shinyapps.io/covid/).

```{r japan_wk, include=FALSE}

# make a list
japan_wk <- list(
#  map_df = prefectures_map,
  area_df = in_japan_wk,
  area_menu = pref_eng$prefecture
)

usethis::use_data(japan_wk, overwrite = TRUE)
```

EOL
